<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Virtual IoT Lab - ESP32 Simulator</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: #0a0e27;
            color: #fff;
            overflow-x: hidden;
        }

        /* Background Grid Animation */
        #bgCanvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            opacity: 0.3;
        }

        /* Header */
        header {
            position: relative;
            z-index: 10;
            padding: 20px 40px;
            background: rgba(10, 14, 39, 0.9);
            backdrop-filter: blur(10px);
            border-bottom: 2px solid #00d9ff;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-family: 'Orbitron', sans-serif;
            font-size: 28px;
            font-weight: 900;
            background: linear-gradient(135deg, #00d9ff, #7b2ff7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 20px rgba(0, 217, 255, 0.5);
        }

        .header-controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, #7b2ff7, #00d9ff);
            border: none;
            border-radius: 8px;
            color: white;
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 0 20px rgba(123, 47, 247, 0.5);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 0 30px rgba(0, 217, 255, 0.8);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid #00d9ff;
            box-shadow: none;
        }

        .theme-toggle {
            width: 50px;
            height: 25px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            border: 1px solid #00d9ff;
            cursor: pointer;
            position: relative;
            transition: all 0.3s;
        }

        .theme-toggle::after {
            content: '';
            position: absolute;
            width: 19px;
            height: 19px;
            background: #00d9ff;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: all 0.3s;
            box-shadow: 0 0 10px #00d9ff;
        }

        .theme-toggle.light::after {
            left: 27px;
            background: #7b2ff7;
            box-shadow: 0 0 10px #7b2ff7;
        }

        body.light-mode {
            background: #f0f4ff;
            color: #0a0e27;
        }

        body.light-mode header {
            background: rgba(240, 244, 255, 0.9);
            border-bottom-color: #7b2ff7;
        }

        /* Main Container */
        .container {
            position: relative;
            z-index: 1;
            display: grid;
            grid-template-columns: 250px 1fr 400px;
            gap: 20px;
            padding: 20px;
            height: calc(100vh - 100px);
        }

        /* Sidebar - Components */
        .sidebar {
            background: rgba(15, 20, 45, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid #00d9ff;
            border-radius: 15px;
            padding: 20px;
            overflow-y: auto;
        }

        .sidebar h2 {
            font-family: 'Orbitron', sans-serif;
            font-size: 20px;
            margin-bottom: 20px;
            color: #00d9ff;
            text-shadow: 0 0 10px rgba(0, 217, 255, 0.5);
        }

        .component-item {
            background: rgba(123, 47, 247, 0.1);
            border: 2px solid #7b2ff7;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            cursor: grab;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .component-item:hover {
            transform: translateX(5px);
            box-shadow: 0 0 20px rgba(123, 47, 247, 0.6);
            border-color: #00d9ff;
        }

        .component-item:active {
            cursor: grabbing;
        }

        .component-icon {
            font-size: 24px;
        }

        /* Workspace - Board Area */
        .workspace {
            background: rgba(15, 20, 45, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid #00d9ff;
            border-radius: 15px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .board-container {
            flex: 1;
            position: relative;
            background: rgba(0, 0, 0, 0.3);
            border: 2px dashed #00d9ff;
            border-radius: 10px;
            overflow: hidden;
        }

        #boardCanvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        /* ESP32 Board Visualization */
        .esp32-board {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 300px;
            height: 180px;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            border: 3px solid #00d9ff;
            border-radius: 15px;
            box-shadow: 0 0 30px rgba(0, 217, 255, 0.5);
            padding: 20px;
        }

        .board-label {
            font-family: 'Orbitron', sans-serif;
            color: #00d9ff;
            font-size: 18px;
            text-align: center;
            margin-bottom: 10px;
        }

        .pin-row {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
        }

        .pin {
            width: 8px;
            height: 8px;
            background: #7b2ff7;
            border-radius: 50%;
            box-shadow: 0 0 8px #7b2ff7;
        }

        /* Dropped Components on Board */
        .dropped-component {
            position: absolute;
            padding: 10px;
            background: rgba(123, 47, 247, 0.9);
            border: 2px solid #00d9ff;
            border-radius: 8px;
            cursor: move;
            box-shadow: 0 0 20px rgba(0, 217, 255, 0.5);
            font-size: 14px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            min-width: 100px;
        }

        .component-value {
            font-family: 'Orbitron', sans-serif;
            color: #00ff00;
            font-size: 16px;
            font-weight: bold;
        }

        .component-remove {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 20px;
            height: 20px;
            background: #ff0055;
            border: 2px solid #fff;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        /* Terminal */
        .terminal {
            height: 150px;
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid #00d9ff;
            border-radius: 10px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            overflow-y: auto;
            color: #00ff00;
        }

        .terminal-line {
            margin-bottom: 5px;
        }

        .terminal-line.error {
            color: #ff0055;
        }

        .terminal-line.info {
            color: #00d9ff;
        }

        /* Right Panel - Code Editor */
        .code-panel {
            background: rgba(15, 20, 45, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid #00d9ff;
            border-radius: 15px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .code-panel h2 {
            font-family: 'Orbitron', sans-serif;
            font-size: 20px;
            color: #00d9ff;
            text-shadow: 0 0 10px rgba(0, 217, 255, 0.5);
        }

        #codeEditor {
            flex: 1;
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid #7b2ff7;
            border-radius: 10px;
            padding: 15px;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            resize: none;
        }

        .code-controls {
            display: flex;
            gap: 10px;
        }

        .code-controls .btn {
            flex: 1;
        }

        /* LED Component */
        .led-light {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #333;
            margin: 5px auto;
            transition: all 0.3s;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5);
        }

        .led-light.on {
            background: #ff0055;
            box-shadow: 0 0 30px #ff0055, inset 0 0 10px rgba(255, 255, 255, 0.5);
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: #7b2ff7;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #00d9ff;
        }

        /* Tutorial Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            position: relative;
            background: rgba(15, 20, 45, 0.95);
            border: 2px solid #00d9ff;
            border-radius: 15px;
            margin: 5% auto;
            padding: 30px;
            width: 80%;
            max-width: 700px;
            box-shadow: 0 0 50px rgba(0, 217, 255, 0.5);
        }

        .close-modal {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 30px;
            color: #00d9ff;
            cursor: pointer;
        }

        .modal h2 {
            font-family: 'Orbitron', sans-serif;
            color: #00d9ff;
            margin-bottom: 20px;
        }

        .tutorial-item {
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(123, 47, 247, 0.1);
            border-left: 3px solid #7b2ff7;
            border-radius: 5px;
        }

        .tutorial-item h3 {
            color: #00d9ff;
            margin-bottom: 10px;
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .container {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto auto;
            }

            .sidebar, .code-panel {
                height: auto;
                max-height: 300px;
            }
        }

        @media (max-width: 768px) {
            header {
                padding: 15px 20px;
                flex-direction: column;
                gap: 15px;
            }

            .logo {
                font-size: 22px;
            }

            .container {
                padding: 10px;
                gap: 10px;
            }

            .esp32-board {
                width: 250px;
                height: 150px;
            }
        }
    </style>
</head>
<body>
    <!-- Background Canvas for Grid Animation -->
    <canvas id="bgCanvas"></canvas>

    <!-- Header -->
    <header>
        <div class="logo">⚡ VIRTUAL IoT LAB</div>
        <div class="header-controls">
            <button class="btn btn-secondary" onclick="showTutorial()">📚 Tutorial</button>
            <button class="btn btn-secondary" onclick="resetLab()">🔄 Reset Lab</button>
            <div class="theme-toggle" onclick="toggleTheme()"></div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="container">
        <!-- Sidebar - Components Library -->
        <div class="sidebar">
            <h2>📦 Komponen IoT</h2>
            <div class="component-item" draggable="true" data-type="led">
                <span class="component-icon">💡</span>
                <span>LED</span>
            </div>
            <div class="component-item" draggable="true" data-type="temp">
                <span class="component-icon">🌡️</span>
                <span>Sensor Suhu</span>
            </div>
            <div class="component-item" draggable="true" data-type="distance">
                <span class="component-icon">📏</span>
                <span>Sensor Jarak</span>
            </div>
            <div class="component-item" draggable="true" data-type="rfid">
                <span class="component-icon">💳</span>
                <span>RFID Reader</span>
            </div>
            <div class="component-item" draggable="true" data-type="servo">
                <span class="component-icon">⚙️</span>
                <span>Servo Motor</span>
            </div>
        </div>

        <!-- Workspace - Board Area -->
        <div class="workspace">
            <div class="board-container" id="boardContainer">
                <div class="esp32-board">
                    <div class="board-label">ESP32 DevKit</div>
                    <div class="pin-row">
                        <div class="pin"></div>
                        <div class="pin"></div>
                        <div class="pin"></div>
                        <div class="pin"></div>
                        <div class="pin"></div>
                        <div class="pin"></div>
                        <div class="pin"></div>
                        <div class="pin"></div>
                    </div>
                    <div style="text-align: center; margin: 20px 0; color: #7b2ff7; font-size: 12px;">
                        WiFi + Bluetooth<br>Dual Core
                    </div>
                    <div class="pin-row">
                        <div class="pin"></div>
                        <div class="pin"></div>
                        <div class="pin"></div>
                        <div class="pin"></div>
                        <div class="pin"></div>
                        <div class="pin"></div>
                        <div class="pin"></div>
                        <div class="pin"></div>
                    </div>
                </div>
            </div>

            <!-- Terminal Output -->
            <div class="terminal" id="terminal">
                <div class="terminal-line info">🚀 Virtual IoT Lab initialized...</div>
                <div class="terminal-line">Ready to simulate IoT devices!</div>
            </div>
        </div>

        <!-- Right Panel - Code Editor -->
        <div class="code-panel">
            <h2>📝 Pseudo Code Editor</h2>
            <textarea id="codeEditor" placeholder="// Tulis kode pseudo di sini...
// Contoh:
// if (temp > 30) {
//     LED.on();
// } else {
//     LED.off();
// }
// 
// if (distance < 10) {
//     servo.angle(90);
// }"></textarea>
            <div class="code-controls">
                <button class="btn" onclick="runSimulation()">▶️ Run Simulation</button>
                <button class="btn btn-secondary" onclick="clearCode()">🗑️ Clear</button>
            </div>
        </div>
    </div>

    <!-- Tutorial Modal -->
    <div id="tutorialModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeTutorial()">&times;</span>
            <h2>📚 Tutorial Virtual IoT Lab</h2>
            
            <div class="tutorial-item">
                <h3>💡 LED</h3>
                <p>LED dapat dikontrol dengan perintah <code>LED.on()</code> atau <code>LED.off()</code>. Drag LED ke board dan gunakan kode untuk mengontrolnya.</p>
            </div>

            <div class="tutorial-item">
                <h3>🌡️ Sensor Suhu</h3>
                <p>Sensor suhu menghasilkan nilai acak 25-35°C. Gunakan variabel <code>temp</code> untuk membaca nilai suhu dalam kode Anda.</p>
            </div>

            <div class="tutorial-item">
                <h3>📏 Sensor Jarak</h3>
                <p>Sensor jarak ultrasonic menghasilkan nilai 5-100 cm. Gunakan variabel <code>distance</code> untuk membaca jarak.</p>
            </div>

            <div class="tutorial-item">
                <h3>💳 RFID Reader</h3>
                <p>RFID dapat mendeteksi kartu virtual. Klik pada RFID di board untuk scan. Gunakan <code>RFID.scan()</code> dalam kode.</p>
            </div>

            <div class="tutorial-item">
                <h3>⚙️ Servo Motor</h3>
                <p>Servo dapat diatur sudutnya 0-180°. Gunakan <code>servo.angle(90)</code> untuk mengatur posisi servo.</p>
            </div>
        </div>
    </div>

    <script>
        // ==================== BACKGROUND ANIMATION ====================
        const bgCanvas = document.getElementById('bgCanvas');
        const bgCtx = bgCanvas.getContext('2d');
        
        bgCanvas.width = window.innerWidth;
        bgCanvas.height = window.innerHeight;

        // Grid particles
        const particles = [];
        const particleCount = 50;

        for (let i = 0; i < particleCount; i++) {
            particles.push({
                x: Math.random() * bgCanvas.width,
                y: Math.random() * bgCanvas.height,
                vx: (Math.random() - 0.5) * 0.5,
                vy: (Math.random() - 0.5) * 0.5,
                size: Math.random() * 2 + 1
            });
        }

        function animateBackground() {
            bgCtx.clearRect(0, 0, bgCanvas.width, bgCanvas.height);
            
            // Draw grid
            bgCtx.strokeStyle = 'rgba(0, 217, 255, 0.1)';
            bgCtx.lineWidth = 1;
            
            for (let i = 0; i < bgCanvas.width; i += 50) {
                bgCtx.beginPath();
                bgCtx.moveTo(i, 0);
                bgCtx.lineTo(i, bgCanvas.height);
                bgCtx.stroke();
            }
            
            for (let i = 0; i < bgCanvas.height; i += 50) {
                bgCtx.beginPath();
                bgCtx.moveTo(0, i);
                bgCtx.lineTo(bgCanvas.width, i);
                bgCtx.stroke();
            }

            // Animate particles
            particles.forEach(p => {
                p.x += p.vx;
                p.y += p.vy;

                if (p.x < 0 || p.x > bgCanvas.width) p.vx *= -1;
                if (p.y < 0 || p.y > bgCanvas.height) p.vy *= -1;

                bgCtx.beginPath();
                bgCtx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                bgCtx.fillStyle = 'rgba(123, 47, 247, 0.8)';
                bgCtx.fill();

                // Connect nearby particles
                particles.forEach(p2 => {
                    const dx = p.x - p2.x;
                    const dy = p.y - p2.y;
                    const dist = Math.sqrt(dx * dx + dy * dy);

                    if (dist < 100) {
                        bgCtx.beginPath();
                        bgCtx.moveTo(p.x, p.y);
                        bgCtx.lineTo(p2.x, p2.y);
                        bgCtx.strokeStyle = `rgba(0, 217, 255, ${0.2 - dist / 500})`;
                        bgCtx.stroke();
                    }
                });
            });

            requestAnimationFrame(animateBackground);
        }

        animateBackground();

        window.addEventListener('resize', () => {
            bgCanvas.width = window.innerWidth;
            bgCanvas.height = window.innerHeight;
        });

        // ==================== DRAG & DROP COMPONENTS ====================
        const components = document.querySelectorAll('.component-item');
        const boardContainer = document.getElementById('boardContainer');
        let draggedElement = null;
        let droppedComponents = [];

        components.forEach(comp => {
            comp.addEventListener('dragstart', (e) => {
                draggedElement = e.target.closest('.component-item');
                e.dataTransfer.effectAllowed = 'copy';
            });
        });

        boardContainer.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'copy';
        });

        boardContainer.addEventListener('drop', (e) => {
            e.preventDefault();
            if (!draggedElement) return;

            const rect = boardContainer.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            const type = draggedElement.dataset.type;

            createDroppedComponent(type, x, y);
            addLog(`✅ ${draggedElement.textContent.trim()} ditambahkan ke board`, 'info');
        });

        function createDroppedComponent(type, x, y) {
            const comp = document.createElement('div');
            comp.className = 'dropped-component';
            comp.dataset.type = type;
            comp.style.left = x + 'px';
            comp.style.top = y + 'px';

            const removeBtn = document.createElement('div');
            removeBtn.className = 'component-remove';
            removeBtn.textContent = '×';
            removeBtn.onclick = () => {
                comp.remove();
                droppedComponents = droppedComponents.filter(c => c !== comp);
                addLog(`🗑️ Komponen dihapus`, 'info');
            };

            comp.appendChild(removeBtn);

            let content = '';
            switch(type) {
                case 'led':
                    content = `<span class="component-icon">💡</span>
                               <span>LED</span>
                               <div class="led-light" id="led_${Date.now()}"></div>`;
                    break;
                case 'temp':
                    const temp = (Math.random() * 10 + 25).toFixed(1);
                    content = `<span class="component-icon">🌡️</span>
                               <span>Suhu</span>
                               <div class="component-value">${temp}°C</div>`;
                    break;
                case 'distance':
                    const dist = Math.floor(Math.random() * 95 + 5);
                    content = `<span class="component-icon">📏</span>
                               <span>Jarak</span>
                               <div class="component-value">${dist} cm</div>`;
                    break;
                case 'rfid':
                    content = `<span class="component-icon">💳</span>
                               <span>RFID</span>
                               <button class="btn" style="font-size: 10px; padding: 5px 10px; margin-top: 5px;" onclick="scanRFID(this)">Scan</button>`;
                    break;
                case 'servo':
                    content = `<span class="component-icon">⚙️</span>
                               <span>Servo</span>
                               <div class="component-value">90°</div>`;
                    break;
            }

            comp.innerHTML = removeBtn.outerHTML + content;
            boardContainer.appendChild(comp);
            droppedComponents.push(comp);

            // Make component draggable within board
            makeDraggable(comp);

            // Save to localStorage
            saveLabState();
        }

        function makeDraggable(element) {
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
            
            element.onmousedown = dragMouseDown;

            function dragMouseDown(e) {
                if (e.target.classList.contains('component-remove') || e.target.tagName === 'BUTTON') return;
                e.preventDefault();
                pos3 = e.clientX;
                pos4 = e.clientY;
                document.onmouseup = closeDragElement;
                document.onmousemove = elementDrag;
            }

            function elementDrag(e) {
                e.preventDefault();
                pos1 = pos3 - e.clientX;
                pos2 = pos4 - e.clientY;
                pos3 = e.clientX;
                pos4 = e.clientY;
                element.style.top = (element.offsetTop - pos2) + "px";
                element.style.left = (element.offsetLeft - pos1) + "px";
            }

            function closeDragElement() {
                document.onmouseup = null;
                document.onmousemove = null;
                saveLabState();
            }
        }

        // ==================== RFID SCAN ====================
        function scanRFID(btn) {
            const rfidId = '0x' + Math.random().toString(16).substr(2, 6).toUpperCase();
            const valueDiv = btn.previousElementSibling;
            
            if (valueDiv && valueDiv.classList.contains('component-value')) {
                valueDiv.textContent = rfidId;
            } else {
                const newDiv = document.createElement('div');
                newDiv.className = 'component-value';
                newDiv.textContent = rfidId;
                btn.parentElement.insertBefore(newDiv, btn);
            }
            
            addLog(`💳 RFID tag detected: ${rfidId}`, 'info');
        }

        // ==================== TERMINAL ====================
        const terminal = document.getElementById('terminal');

        function addLog(message, type = 'normal') {
            const line = document.createElement('div');
            line.className = 'terminal-line ' + type;
            line.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            terminal.appendChild(line);
            terminal.scrollTop = terminal.scrollHeight;
        }

        // ==================== CODE EXECUTION ====================
        function runSimulation() {
            const code = document.getElementById('codeEditor').value;
            
            if (!code.trim()) {
                addLog('⚠️ Tidak ada kode untuk dijalankan!', 'error');
                return;
            }

            addLog('🚀 Menjalankan simulasi...', 'info');

            // Update sensor values
            droppedComponents.forEach(comp => {
                const type = comp.dataset.type;
                
                if (type === 'temp') {
                    const temp = (Math.random() * 10 + 25).toFixed(1);
                    const valueDiv = comp.querySelector('.component-value');
                    if (valueDiv) valueDiv.textContent = temp + '°C';
                    window.temp = parseFloat(temp);
                } else if (type === 'distance') {
                    const dist = Math.floor(Math.random() * 95 + 5);
                    const valueDiv = comp.querySelector('.component-value');
                    if (valueDiv) valueDiv.textContent = dist + ' cm';
                    window.distance = dist;
                }
            });

            // Simple code parser for pseudo code
            try {
                // Parse LED control
                if (code.match(/LED\.on\(\)/i)) {
                    const leds = document.querySelectorAll('.led-light');
                    leds.forEach(led => {
                        led.classList.add('on');
                        addLog('💡 LED turned ON');
                    });
                }
                
                if (code.match(/LED\.off\(\)/i)) {
                    const leds = document.querySelectorAll('.led-light');
                    leds.forEach(led => {
                        led.classList.remove('on');
                        addLog('💡 LED turned OFF');
                    });
                }

                // Parse conditional logic for LED
                const tempMatch = code.match(/if\s*\(\s*temp\s*([><=!]+)\s*(\d+)\s*\)\s*{?\s*LED\.on\(\)/i);
                if (tempMatch && window.temp !== undefined) {
                    const operator = tempMatch[1];
                    const value = parseFloat(tempMatch[2]);
                    let condition = false;

                    if (operator.includes('>')) condition = window.temp > value;
                    else if (operator.includes('<')) condition = window.temp < value;
                    else if (operator.includes('==')) condition = window.temp == value;

                    if (condition) {
                        const leds = document.querySelectorAll('.led-light');
                        leds.forEach(led => led.classList.add('on'));
                        addLog(`💡 LED ON (temp: ${window.temp}°C ${operator} ${value}°C)`);
                    }
                }

                const tempMatchOff = code.match(/else\s*{?\s*LED\.off\(\)/i);
                if (tempMatchOff && window.temp !== undefined) {
                    const leds = document.querySelectorAll('.led-light');
                    leds.forEach(led => led.classList.remove('on'));
                    addLog(`💡 LED OFF (kondisi else)`);
                }

                // Parse servo control
                const servoMatch = code.match(/servo\.angle\((\d+)\)/i);
                if (servoMatch) {
                    const angle = parseInt(servoMatch[1]);
                    const servos = document.querySelectorAll('[data-type="servo"] .component-value');
                    servos.forEach(servo => {
                        servo.textContent = angle + '°';
                        addLog(`⚙️ Servo angle set to ${angle}°`);
                    });
                }

                // Parse RFID scan
                if (code.match(/RFID\.scan\(\)/i)) {
                    const rfidButtons = document.querySelectorAll('[data-type="rfid"] button');
                    rfidButtons.forEach(btn => {
                        scanRFID(btn);
                    });
                }

                addLog('✅ Simulasi selesai!', 'info');
            } catch (error) {
                addLog('❌ Error: ' + error.message, 'error');
            }

            saveLabState();
        }

        function clearCode() {
            document.getElementById('codeEditor').value = '';
            addLog('🗑️ Code editor cleared', 'info');
        }

        // ==================== THEME TOGGLE ====================
        function toggleTheme() {
            document.body.classList.toggle('light-mode');
            document.querySelector('.theme-toggle').classList.toggle('light');
            saveLabState();
        }

        // ==================== TUTORIAL MODAL ====================
        function showTutorial() {
            document.getElementById('tutorialModal').style.display = 'block';
        }

        function closeTutorial() {
            document.getElementById('tutorialModal').style.display = 'none';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('tutorialModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }

        // ==================== RESET LAB ====================
        function resetLab() {
            droppedComponents.forEach(comp => comp.remove());
            droppedComponents = [];
            document.getElementById('codeEditor').value = '';
            terminal.innerHTML = `
                <div class="terminal-line info">🚀 Virtual IoT Lab initialized...</div>
                <div class="terminal-line">Ready to simulate IoT devices!</div>
            `;
            
            const leds = document.querySelectorAll('.led-light');
            leds.forEach(led => led.classList.remove('on'));
            
            addLog('🔄 Lab has been reset!', 'info');
            
            // Clear localStorage
            localStorage.removeItem('iotLabState');
        }

        // ==================== LOCAL STORAGE ====================
        function saveLabState() {
            const state = {
                components: droppedComponents.map(comp => ({
                    type: comp.dataset.type,
                    left: comp.style.left,
                    top: comp.style.top,
                    html: comp.innerHTML
                })),
                code: document.getElementById('codeEditor').value,
                theme: document.body.classList.contains('light-mode')
            };
            
            localStorage.setItem('iotLabState', JSON.stringify(state));
        }

        function loadLabState() {
            const saved = localStorage.getItem('iotLabState');
            if (!saved) return;

            try {
                const state = JSON.parse(saved);
                
                // Restore theme
                if (state.theme) {
                    document.body.classList.add('light-mode');
                    document.querySelector('.theme-toggle').classList.add('light');
                }
                
                // Restore code
                document.getElementById('codeEditor').value = state.code || '';
                
                // Restore components
                state.components.forEach(compData => {
                    const comp = document.createElement('div');
                    comp.className = 'dropped-component';
                    comp.dataset.type = compData.type;
                    comp.style.left = compData.left;
                    comp.style.top = compData.top;
                    comp.innerHTML = compData.html;
                    
                    // Re-attach event listeners
                    const removeBtn = comp.querySelector('.component-remove');
                    if (removeBtn) {
                        removeBtn.onclick = () => {
                            comp.remove();
                            droppedComponents = droppedComponents.filter(c => c !== comp);
                            addLog(`🗑️ Komponen dihapus`, 'info');
                        };
                    }
                    
                    const rfidBtn = comp.querySelector('button');
                    if (rfidBtn) {
                        rfidBtn.onclick = function() { scanRFID(this); };
                    }
                    
                    boardContainer.appendChild(comp);
                    droppedComponents.push(comp);
                    makeDraggable(comp);
                });
                
                addLog('📂 Lab state restored from previous session', 'info');
            } catch (error) {
                console.error('Failed to load lab state:', error);
            }
        }

        // ==================== INITIALIZATION ====================
        window.addEventListener('load', () => {
            loadLabState();
            addLog('🎯 Drag komponen dari sidebar ke board untuk memulai!', 'info');
        });

        // Auto-save every 5 seconds if there are changes
        setInterval(() => {
            if (droppedComponents.length > 0 || document.getElementById('codeEditor').value) {
                saveLabState();
            }
        }, 5000);
    </script>